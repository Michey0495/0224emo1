# AI生成コードのリスクガイド

emo1 セミナー資料 | 2026年2月24日
Author: Givery EZOAI 安田光喜

---

AIにコードを書かせると生産性は跳ね上がります。ただし、生成されたコードをそのまま使うのは危険です。このガイドでは、AI生成コードに潜むリスクを5つのカテゴリに分けて整理し、emo1 アプリで実際にどう対策しているかを示していきます。


## 1. セキュリティリスク

### 1-1. APIキーのハードコーディング

リスク: AIはサンプルコードを生成する際、APIキーを直接ソースコードに埋め込むことがあります。そのままGitHubにプッシュすると、世界中の誰でもそのキーを使える状態になってしまいます。

具体例:
```javascript
// AIが生成しがちなコード（危険）
const openai = new OpenAI({
  apiKey: "sk-proj-abc123..."
});
```

emo1 での対策:
- `.env` ファイルでAPIキーを管理し、`process.env.OPENAI_API_KEY` で読み込みます
- `.gitignore` に `.env` を記載してGit追跡対象から除外しています
- APIキーはサーバー側（server.js）でのみ使用し、ブラウザのコードには一切登場しません
- `.env.example` をテンプレートとして同梱しています（値は空）

### 1-2. XSS（クロスサイトスクリプティング）

リスク: ユーザーが入力フォームに `<script>alert('hack')</script>` のようなコードを打ち込み、それがそのまま画面に出力されると、ブラウザ上で悪意あるスクリプトが実行されます。AIが生成したフロントエンドコードでは、この対策が抜けていることが少なくありません。

具体例:
```javascript
// AIが生成しがちなコード（危険）
chatArea.innerHTML = userMessage;
```

emo1 での対策:
- サーバー側で `sanitize-html` を使い、すべてのHTMLタグを除去してからOpenAIに送信しています
- クライアント側でもHTMLエスケープ関数を実装し、ユーザーメッセージの表示時に `<` `>` `"` `'` `&` をエスケープしています
- マークダウンレンダリング時もコードブロック内のHTMLはエスケープ処理を施しています

### 1-3. インジェクション攻撃

リスク: 入力値に対するバリデーションが甘いと、意図しないデータがサーバーに到達します。プロンプトインジェクション（AIへの指示を書き換える攻撃）もこのカテゴリに含まれます。

emo1 での対策:
- テキスト入力に `maxlength="4000"` を設定し、長大な入力を制限しています
- サーバー側で `express.json({ limit: "1mb" })` によりリクエストボディのサイズを制限しています
- `sanitizeInput()` 関数で全タグを除去します
- `validateMessages()` 関数でメッセージ配列の形式を検証し、許可されたロール（`user` / `assistant`）以外を拒否します
- Helmet による `Content-Security-Policy` 等のセキュリティヘッダーを付与しています


## 2. 品質リスク

### 2-1. 過剰なコード生成

リスク: AIは求められた以上のコードを生成する傾向があります。使われない関数、不要なライブラリのimport、過剰に汎用化された抽象レイヤーが混入し、コードの見通しが悪くなりがちです。

emo1 での対策:
- 機能ごとにファイルを分離しています（server.js / index.html / style.css / app.js）
- サーバー側は Express のルーティングのみ、クライアント側はDOM操作のみ、という明確な責務分担を行っています
- 不要なコードは生成後に手動レビューで削除済みです

### 2-2. エラーハンドリングの不足

リスク: AIが生成するコードは「正常系」が中心になりがちです。ネットワーク切断、APIのレート制限超過、タイムアウトといった異常系の処理が抜け落ちることが珍しくありません。

具体例:
```javascript
// AIが生成しがちなコード（エラー処理なし）
const response = await fetch('/api/chat', { method: 'POST', body: JSON.stringify(data) });
const result = await response.json();
```

emo1 での対策:
- server.js の `/api/chat` エンドポイントで try-catch を使用しています
- APIキー未設定時は 500 エラーを明示的に返却します
- ストリーミング中のエラーは SSE 形式でクライアントに通知します
- ヘッダー送信前/後でエラー返却方式を分岐しています（JSON or SSE）
- クライアント側でもネットワークエラー時にユーザーへメッセージを表示します

### 2-3. テスト不足

リスク: AIはテストコードを頼まなければ書きません。書いたとしても正常系のハッピーパスだけで、境界値やエッジケースのテストが不足しがちです。

対策:
- 本アプリはセミナー用のため自動テストは省略していますが、手動テストとして以下の確認を推奨します
  - APIキー未設定状態での起動と動作確認
  - 空メッセージの送信
  - 4000文字を超える入力
  - HTMLタグを含む入力
  - 連打による高速連続送信（レート制限の発動確認）


## 3. 依存関係リスク

### 3-1. 古いパッケージの使用

リスク: AIの学習データは特定の時点で切られています。そのため、生成されるコードが古いバージョンのAPIやパッケージを前提にしていることがあります。脆弱性が修正された新バージョンが出ていても、AI はそれを知りません。

対策:
```bash
# 脆弱性の確認
npm audit

# 修正可能な脆弱性を自動修正
npm audit fix

# パッケージのバージョン確認
npm outdated
```

package.json では `^`（キャレット）を使ったバージョン指定にしてあるため、`npm install` 実行時にマイナー・パッチの更新は自動で取得されます。

### 3-2. 不要な依存の追加

リスク: AIに「チャットアプリを作って」と頼むと、socket.io、mongoose、passport、winston など、要件にないパッケージまで含めて提案することがあります。依存が増えるほど攻撃対象面（attack surface）が広がります。

emo1 での対策:
- 依存パッケージは7つに限定しています
  - `express` ... HTTPサーバー
  - `openai` ... OpenAI API クライアント
  - `dotenv` ... 環境変数読み込み
  - `helmet` ... セキュリティヘッダー
  - `express-rate-limit` ... レート制限
  - `cors` ... CORS制御
  - `sanitize-html` ... 入力サニタイズ
- どれも明確な役割があり、削れるものがない状態です


## 4. 著作権・ライセンスリスク

### 4-1. ライセンス違反の可能性

リスク: AIが生成するコードの中に、オープンソースプロジェクトのコードがそのまま含まれている可能性があります。GPL ライセンスのコードが混入すると、プロジェクト全体を GPL で公開する義務が生じるケースも考えられます。

対策:
```bash
# 使用パッケージのライセンス一覧を確認
npx license-checker --summary

# 特定パッケージのライセンスを確認
npm info express license
```

emo1 で使用しているパッケージはすべて MIT または BSD 系で、商用利用に制限はありません。

### 4-2. 学習データ由来のコード混入

リスク: AIが生成したコードの一部が、特定のオープンソースプロジェクトのコードとほぼ一致する場合があります。意図しないコピーが含まれるリスクは排除できません。

対策:
- 生成されたコードのうち、ビジネスロジック部分は手動でレビューし、独自実装であることを確認しています
- 汎用的なパターン（Express のルーティング定義、fetch の呼び出し方など）は著作権の対象になりにくいとされています
- 気になるコード片がある場合は、GitHub のコード検索で類似コードがないか確認するのが実務上の対処法です


## 5. 運用リスク

### 5-1. コスト管理

リスク: OpenAI API は従量課金です。ユーザーが大量のメッセージを送ったり、長文のプロンプトを繰り返すと、想定外の費用が発生します。

emo1 での対策:
- `express-rate-limit` で1分あたり20リクエストに制限しています（同一IPごと）
- テキスト入力に `maxlength="4000"` を設定しています
- `max_tokens: 2048` でAIの応答長も制限しています
- OpenAI ダッシュボード（https://platform.openai.com/usage）で使用量を日次確認する運用を推奨します

コスト感の目安: gpt-4o-mini の場合、入力100万トークンあたり約$0.15、出力100万トークンあたり約$0.60です。セミナー中の利用であれば数ドル程度に収まるのが通常です。

### 5-2. 可用性（API障害時の対応）

リスク: OpenAI API が障害でダウンしている場合、アプリ全体が使えなくなります。外部APIに依存するアプリに共通するリスクです。

emo1 での対策:
- `/api/health` エンドポイントでAPIキーの設定状況を確認できます
- API呼び出し失敗時はエラーメッセージをユーザーに返します（画面が固まったまま無反応にはなりません）
- ストリーミング中にエラーが発生しても SSE 形式でエラー通知を返し、接続をクローズします

本番環境では、リトライ処理、サーキットブレーカー、フォールバック応答などの追加が望ましいでしょう。


## AI生成コード 本番投入前チェックリスト

AI が生成したコードを本番環境へデプロイする前に、以下の項目を一つずつ確認してください。

- [ ] APIキー・シークレットがソースコードにハードコーディングされていないか
- [ ] `.gitignore` に `.env` やクレデンシャルファイルが含まれているか
- [ ] ユーザー入力にサニタイズ・バリデーションが適用されているか
- [ ] エラーハンドリングが全てのAPI呼び出しに実装されているか
- [ ] 不要なパッケージが `package.json` に含まれていないか
- [ ] `npm audit` で脆弱性が報告されていないか
- [ ] 使用パッケージのライセンスが自社のポリシーに適合しているか
- [ ] レート制限やリクエストサイズ制限が適切に設定されているか
- [ ] HTTPS が有効化されているか（本番環境）
- [ ] ログに機密情報（APIキー、個人情報）が出力されていないか
- [ ] エラーメッセージからサーバーの内部情報（スタックトレース等）が漏れていないか
- [ ] CORS の許可オリジンが必要最小限に絞られているか
